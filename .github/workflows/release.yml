name: release

on:
  push:
    tags:
      - 'n1*'


env:
  KERNEL_VERSION_NAME: 6.1.80_5.4.269_5.15.150_5.10.210
  WGET: https://github.com/xrcuo/Actions-OpenWrt-N1/releases/download/v1.0/openwrt-armvirt-64-generic-rootfs.tar.gz

jobs:
  goreleaser:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
  
      - name: Get OpenWrt firmware
        id: build
        if: (!cancelled())
        run: |
          wget -q -P openwrt-armvirt $WGET
      

      - name: Set up Go
        uses: unifreq/openwrt_packit@master
        env:
          WHOAMI: deng
          OPENWRT_ARMVIRT: openwrt-armvirt/*.tar.gz
          PACKAGE_SOC: s905d
          KERNEL_VERSION_NAME: 6.1.80_5.4.269_5.15.150_5.10.210

      - name: Run GoReleaser
        uses: ncipollo/release-action@v1
        with:
          artifacts: ${{ env.PACKAGED_OUTPUTPATH }}/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 清理Actions空间
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHDSQ_TOKEN }}
          repository: ${{ github.repository }}
          keep_minimum_runs: 0
          retain_days: 5
          #retain_days: ${{ github.event.inputs.action_days }}
        
      - name: 删除多余releases
        uses: dev-drprasad/delete-older-releases@master
        with:
          repo: ${{ github.repository }}
          keep_latest: 5
          #keep_latest: ${{ github.event.inputs.rele }}
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHDSQ_TOKEN }}
